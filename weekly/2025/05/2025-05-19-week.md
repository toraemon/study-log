# 🗓️ 2025年05月21日（水曜日）学習ログ（WebAPI:TheGoodParts：6章）

## ✅ 学習概要

- 要点
  - [Good] 個人情報など特定のユーザー以外に漏洩したくない情報がある場合はHTTPSを使う
  - [Good] XSS、CSRFなど通常のウェブと同様のセキュリティだけでなくJSONハイジャックなどAPI特有の脆弱性に気を配る
  - [Good] セキュリティ強化に繋がるHTTPヘッダをきちんとつける
  - [Good] レートリミットを設けることで一部のユーザーによる過度のアクセスによる負荷を防ぐ

---

## ⏱ 学習時間
45分

---

## 📚 使用教材

- 『Web API: The Good Parts』（第 6 章）

---

## 📖 学習範囲・内容

- 安全性と安定性の観点からWebAPIを考える必要がある
　1. XSS：ユーザーの入力を受け取ってそれをページのHTMLに埋め込んで表示する際に、ユーザーから送られたJavaScriptなどを実行できてしまう
　　　→Content-Typeを明示的に指定する、ヘッダレスポンスを適切に指定する（2025年時点でどこまで考慮するかChatGPTに相談）
　2. CSRF：サイトを跨いで偽造したリクエストを送りつけることにより、ユーザーが意図しない処理をサーバに実行させてしまう
    →CSRFトークンを使用して、トークンがない場合はアクセスを弾く
    →特別なリクエストヘッダをつけてもらい、ヘッダがない場合はアクセスを弾く
　3. JSONハイジャック：APIからJSONで送られてくる情報を悪意ある第三者が盗み取ること
    →JSONをSCRIPT要素では読み込めないようにする
　　 →JSONをブラウザが必ずJSONと認識するようにする
　 　→JSONをJavaScriptとして解釈不可能、あるいは実行時にデータを読み込めないようにする　　
- 悪意のあるリクエスト：パラメータの改ざん、リクエストの再送信
- セキュリティ関係のHTTPヘッダ：X-Content-Type-Options、X-XSS-Protection、X-Frame-Options、Content-Security-Policy、Strict-Transport-Security、Public-Key-Pins、Set-Cookieヘッダとセキュリティ
- 大量アクセスへの対策
　1. ユーザーごとにアクセスを制限する（リミット制限：ユーザの識別方法、リミット値、リミットの単位、リセットのタイミングなどを検討）
　2. レートリミットの導入
　3. 制限値を超えた場合の対応は新しいステータスコードの429 TooManyRequestsがある（403や503などを使用しているAPIもある）

---

## 📊 疑問点と確認結果

### ①XSSの基本的な意味、XSSへのベストプラクティスは？
#### ① XSS（クロスサイトスクリプティング）
** ✅ 基本的な意味：**
- 悪意あるスクリプト（JavaScriptなど）をWebページに埋め込む攻撃。
- ユーザーがそのページを閲覧すると、意図しないスクリプトが実行される。
- たとえば掲示板の投稿フォームに ```<script>alert("XSS")</script>``` を入力すると、表示時にそのスクリプトが動く。

**🛡 ベストプラクティス：**
- 出力時エスケープ：HTMLに埋め込むデータは &, <, > などを必ずエスケープする。
- テンプレートエンジンの活用：React, Vueなどのフレームワークは自動的にエスケープしてくれる。
- Content Security Policy (CSP) を設定して、スクリプトの実行元を制限する。
- 入力の検証はあくまで補助。出力側でのエスケープが最重要にゃ！

#### ② CSRF（クロスサイトリクエストフォージェリ）
**✅ 基本的な意味：**
- 認証済みのユーザーが意図しないリクエストを外部サイト経由で送ってしまう攻撃。
- たとえば「自分のブログを削除する」リンクを、悪意あるサイトがこっそり踏ませると…実行されてしまう。

**🛡 ベストプラクティス：**
- SameSite属性付きのCookieを使用する（StrictまたはLax）。
- CSRFトークンの導入：フォーム送信時にトークンを発行し、サーバー側で検証する。
- CORS制限：外部オリジンからのリクエストをブロックする。
- 認証情報（Cookieやセッション）を使わないAPIはCSRFに強いので、JWTのような仕組みを使うのも有効にゃ。

#### ③ JSONハイジャック

**✅ 基本的な意味：**
- JSONデータを <script> タグで読み込ませることで、機密情報をJavaScript経由で盗まれる攻撃。
- 特に古いブラウザでは、ArrayやObjectのJSONレスポンスがグローバル変数扱いされてしまうことがあるにゃ。

**🛡 ベストプラクティス：**
- JSONレスポンスはapplication/jsonで返すこと（text/htmlだとJSで読み込まれやすくなる）。
- プリフィックスを付ける：例）)]}',\n{"data": ...} など、不正なパースを防ぐ。
- CORSを正しく設定：JSON APIはOriginを確認して、許可されたドメインにだけレスポンスを返す。
- ```X-Content-Type-Options: nosniff``` を設定することで、ブラウザが application/json などのContent-Typeを無視しないようにできるにゃ。

#### 📝 まとめ表
| 用語 | 意味の概要 | 対策のベストプラクティス |
| ---- | ------ | --------- | 
| XSS | スクリプトがWebページに埋め込まれて実行される | 出力時エスケープ / CSP / フレームワーク活用 |
| CSRF | 認証済みユーザーに意図しない操作をさせる | SameSite Cookie / トークン / CORS |
| JSONハイジャック | JSONレスポンスをJSで不正に読み取る攻撃 | application/json返却 / プリフィックス / CORS |

### 🛡セキュリティ強化ヘッダー
| ヘッダー名 | 説明 | 推奨値 |
| ---- | ---- | ---- |
| X-Content-Type-Options | MIMEスニッフィング防止 | nosniff |
| X-Frame-Options | クリックジャッキング防止 | DENY または SAMEORIGIN | 
| Content-Security-Policy | スクリプトなどの読み込み元を制限 | 例：default-src 'self' |
| Strict-Transport-Security | HTTPS強制 | max-age=31536000; includeSubDomains |

---

## 💬 感想・気づき

- 内部の実装についてはこれまでの開発経験である程度知っていたが、APIを開発する際は改めて学ばないといけないことが色々あると再認識した。
- 今後はAPIのベストプラクティスについても学んでいきたいが、自分の理解不足を痛感したそもそものセキュリティ周りの学習を行なっていきたい。

---

## 📕 参考文献（ある場合だけ）

- 教科書関連
- 関連文献
